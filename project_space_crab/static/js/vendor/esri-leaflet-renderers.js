!function(t,i){"object"==typeof exports&&"undefined"!=typeof module?i(exports,require("leaflet"),require("esri-leaflet")):"function"==typeof define&&define.amd?define(["exports","leaflet","esri-leaflet"],i):i((t.L=t.L||{},t.L.esri=t.L.esri||{},t.L.esri.Renderers=t.L.esri.Renderers||{}),t.L,t.L.esri)}(this,function(t,a,i){"use strict";a="default"in a?a.default:a,i="default"in i?i.default:i;var o=a.Class.extend({initialize:function(t,i){this._symbolJson=t,this.val=null,this._styles={},this._isDefault=!1,this._layerTransparency=1,i&&i.layerTransparency&&(this._layerTransparency=1-i.layerTransparency/100)},pixelValue:function(t){return 1.333*t},colorValue:function(t){return"rgb("+t[0]+","+t[1]+","+t[2]+")"},alphaValue:function(t){return t[3]/255*this._layerTransparency},getSize:function(t,i){var e=t.properties,s=i.field,o=0,n=null;if(s){n=e[s];var r=i.minSize,l=i.maxSize,a=i.minDataValue,h=i.maxDataValue,u=i.normalizationField,y=e?parseFloat(e[u]):void 0;if(null===n||u&&(isNaN(y)||0===y))return null;isNaN(y)||(n/=y),null!==r&&null!==l&&null!==a&&null!==h&&(o=n<=a?r:h<=n?l:r+(n-a)/(h-a)*(l-r)),o=isNaN(o)?0:o}return o},getColor:function(t,i){if(!(t.properties&&i&&i.field&&i.stops))return null;var e,s,o,n,r=t.properties,l=r[i.field],a=i.normalizationField,h=r?parseFloat(r[a]):void 0;if(null===l||a&&(isNaN(h)||0===h))return null;if(isNaN(h)||(l/=h),l<=i.stops[0].value)return i.stops[0].color;var u=i.stops[i.stops.length-1];if(l>=u.value)return u.color;for(var y=0;y<i.stops.length;y++){var _=i.stops[y];if(_.value<=l)e=_.color,o=_.value;else if(_.value>l){s=_.color,n=_.value;break}}if(!isNaN(o)&&!isNaN(n)){var c=n-o;if(0<c){var f=(l-o)/c;if(f){var p=(n-l)/c;if(p){for(var d=[],S=0;S<4;S++)d[S]=Math.round(e[S]*p+s[S]*f);return d}return s}return e}}return null}}),s=a.Path.extend({initialize:function(t,i,e){a.setOptions(this,e),this._size=i,this._latlng=a.latLng(t),this._svgCanvasIncludes()},toGeoJSON:function(){return a.GeoJSON.getFeature(this,{type:"Point",coordinates:a.GeoJSON.latLngToCoords(this.getLatLng())})},_svgCanvasIncludes:function(){},_project:function(){this._point=this._map.latLngToLayerPoint(this._latlng)},_update:function(){this._map&&this._updatePath()},_updatePath:function(){},setLatLng:function(t){return this._latlng=a.latLng(t),this.redraw(),this.fire("move",{latlng:this._latlng})},getLatLng:function(){return this._latlng},setSize:function(t){return this._size=t,this.redraw()},getSize:function(){return this._size}}),h=s.extend({initialize:function(t,i,e){s.prototype.initialize.call(this,t,i,e)},_updatePath:function(){this._renderer._updateCrossMarker(this)},_svgCanvasIncludes:function(){a.Canvas.include({_updateCrossMarker:function(t){var i=t._point,e=t._size/2,s=this._ctx;s.beginPath(),s.moveTo(i.x,i.y+e),s.lineTo(i.x,i.y-e),this._fillStroke(s,t),s.moveTo(i.x-e,i.y),s.lineTo(i.x+e,i.y),this._fillStroke(s,t)}}),a.SVG.include({_updateCrossMarker:function(t){var i=t._point,e=t._size/2;a.Browser.vml&&(i._round(),e=Math.round(e));var s="M"+i.x+","+(i.y+e)+"L"+i.x+","+(i.y-e)+"M"+(i.x-e)+","+i.y+"L"+(i.x+e)+","+i.y;this._setPath(t,s)}})}}),u=s.extend({initialize:function(t,i,e){s.prototype.initialize.call(this,t,i,e)},_updatePath:function(){this._renderer._updateXMarker(this)},_svgCanvasIncludes:function(){a.Canvas.include({_updateXMarker:function(t){var i=t._point,e=t._size/2,s=this._ctx;s.beginPath(),s.moveTo(i.x+e,i.y+e),s.lineTo(i.x-e,i.y-e),this._fillStroke(s,t)}}),a.SVG.include({_updateXMarker:function(t){var i=t._point,e=t._size/2;a.Browser.vml&&(i._round(),e=Math.round(e));var s="M"+(i.x+e)+","+(i.y+e)+"L"+(i.x-e)+","+(i.y-e)+"M"+(i.x-e)+","+(i.y+e)+"L"+(i.x+e)+","+(i.y-e);this._setPath(t,s)}})}}),y=s.extend({options:{fill:!0},initialize:function(t,i,e){s.prototype.initialize.call(this,t,i,e)},_updatePath:function(){this._renderer._updateSquareMarker(this)},_svgCanvasIncludes:function(){a.Canvas.include({_updateSquareMarker:function(t){var i=t._point,e=t._size/2,s=this._ctx;s.beginPath(),s.moveTo(i.x+e,i.y+e),s.lineTo(i.x-e,i.y+e),s.lineTo(i.x-e,i.y-e),s.lineTo(i.x+e,i.y-e),s.closePath(),this._fillStroke(s,t)}}),a.SVG.include({_updateSquareMarker:function(t){var i=t._point,e=t._size/2;a.Browser.vml&&(i._round(),e=Math.round(e));var s="M"+(i.x+e)+","+(i.y+e)+"L"+(i.x-e)+","+(i.y+e)+"L"+(i.x-e)+","+(i.y-e)+"L"+(i.x+e)+","+(i.y-e);s+=a.Browser.svg?"z":"x",this._setPath(t,s)}})}}),_=s.extend({options:{fill:!0},initialize:function(t,i,e){s.prototype.initialize.call(this,t,i,e)},_updatePath:function(){this._renderer._updateDiamondMarker(this)},_svgCanvasIncludes:function(){a.Canvas.include({_updateDiamondMarker:function(t){var i=t._point,e=t._size/2,s=this._ctx;s.beginPath(),s.moveTo(i.x,i.y+e),s.lineTo(i.x-e,i.y),s.lineTo(i.x,i.y-e),s.lineTo(i.x+e,i.y),s.closePath(),this._fillStroke(s,t)}}),a.SVG.include({_updateDiamondMarker:function(t){var i=t._point,e=t._size/2;a.Browser.vml&&(i._round(),e=Math.round(e));var s="M"+i.x+","+(i.y+e)+"L"+(i.x-e)+","+i.y+"L"+i.x+","+(i.y-e)+"L"+(i.x+e)+","+i.y;s+=a.Browser.svg?"z":"x",this._setPath(t,s)}})}}),e=o.extend({statics:{MARKERTYPES:["esriSMSCircle","esriSMSCross","esriSMSDiamond","esriSMSSquare","esriSMSX","esriPMS"]},initialize:function(t,i){var e;if(o.prototype.initialize.call(this,t,i),i&&(this.serviceUrl=i.url),t)if("esriPMS"===t.type){var s=this._symbolJson.url;s&&"http://"===s.substr(0,7)||"https://"===s.substr(0,8)?(e=this.sanitize(s),this._iconUrl=e):(e=this.serviceUrl+"images/"+s,this._iconUrl=i&&i.token?e+"?token="+i.token:e),t.imageData&&(this._iconUrl="data:"+t.contentType+";base64,"+t.imageData),this._icons={},this.icon=this._createIcon(this._symbolJson)}else this._fillStyles()},sanitize:function(t){if(!t)return"";var i;try{i=(i=(i=(i=t.replace(/<br>/gi,"\n")).replace(/<p.*>/gi,"\n")).replace(/<a.*href='(.*?)'.*>(.*?)<\/a>/gi," $2 ($1) ")).replace(/<(?:.|\s)*?>/g,"")}catch(t){i=null}return i},_fillStyles:function(){this._symbolJson.outline&&0<this._symbolJson.size&&"esriSLSNull"!==this._symbolJson.outline.style?(this._styles.stroke=!0,this._styles.weight=this.pixelValue(this._symbolJson.outline.width),this._styles.color=this.colorValue(this._symbolJson.outline.color),this._styles.opacity=this.alphaValue(this._symbolJson.outline.color)):this._styles.stroke=!1,this._symbolJson.color?(this._styles.fillColor=this.colorValue(this._symbolJson.color),this._styles.fillOpacity=this.alphaValue(this._symbolJson.color)):this._styles.fillOpacity=0,"esriSMSCircle"===this._symbolJson.style&&(this._styles.radius=this.pixelValue(this._symbolJson.size)/2)},_createIcon:function(t){var i=this.pixelValue(t.width),e=i;t.height&&(e=this.pixelValue(t.height));var s=i/2,o=e/2;t.xoffset&&(s+=this.pixelValue(t.xoffset)),t.yoffset&&(o+=this.pixelValue(t.yoffset));var n=a.icon({iconUrl:this._iconUrl,iconSize:[i,e],iconAnchor:[s,o]});return this._icons[t.width.toString()]=n},_getIcon:function(t){var i=this._icons[t.toString()];return i||(i=this._createIcon({width:t})),i},pointToLayer:function(t,i,e,s){var o=this._symbolJson.size||this._symbolJson.width;if(!this._isDefault){if(e.sizeInfo){var n=this.getSize(t,e.sizeInfo);n&&(o=n)}if(e.colorInfo){var r=this.getColor(t,e.colorInfo);r&&(this._styles.fillColor=this.colorValue(r),this._styles.fillOpacity=this.alphaValue(r))}}if("esriPMS"===this._symbolJson.type){var l=a.extend({},{icon:this._getIcon(o)},s);return a.marker(i,l)}switch(o=this.pixelValue(o),this._symbolJson.style){case"esriSMSSquare":return function(t,i,e){return new y(t,i,e)}(i,o,a.extend({},this._styles,s));case"esriSMSDiamond":return function(t,i,e){return new _(t,i,e)}(i,o,a.extend({},this._styles,s));case"esriSMSCross":return function(t,i,e){return new h(t,i,e)}(i,o,a.extend({},this._styles,s));case"esriSMSX":return function(t,i,e){return new u(t,i,e)}(i,o,a.extend({},this._styles,s))}return this._styles.radius=o/2,a.circleMarker(i,a.extend({},this._styles,s))}});function n(t,i){return new e(t,i)}var r=o.extend({statics:{LINETYPES:["esriSLSDash","esriSLSDot","esriSLSDashDotDot","esriSLSDashDot","esriSLSSolid"]},initialize:function(t,i){o.prototype.initialize.call(this,t,i),this._fillStyles()},_fillStyles:function(){if(this._styles.lineCap="butt",this._styles.lineJoin="miter",this._styles.fill=!1,this._styles.weight=0,!this._symbolJson)return this._styles;if(this._symbolJson.color&&(this._styles.color=this.colorValue(this._symbolJson.color),this._styles.opacity=this.alphaValue(this._symbolJson.color)),!isNaN(this._symbolJson.width)){this._styles.weight=this.pixelValue(this._symbolJson.width);var t=[];switch(this._symbolJson.style){case"esriSLSDash":t=[4,3];break;case"esriSLSDot":t=[1,3];break;case"esriSLSDashDot":t=[8,3,1,3];break;case"esriSLSDashDotDot":t=[8,3,1,3,1,3]}if(0<t.length){for(var i=0;i<t.length;i++)t[i]*=this._styles.weight;this._styles.dashArray=t.join(",")}}},style:function(t,i){if(!this._isDefault&&i){if(i.sizeInfo){var e=this.pixelValue(this.getSize(t,i.sizeInfo));e&&(this._styles.weight=e)}if(i.colorInfo){var s=this.getColor(t,i.colorInfo);s&&(this._styles.color=this.colorValue(s),this._styles.opacity=this.alphaValue(s))}}return this._styles}});function l(t,i){return new r(t,i)}var c=o.extend({statics:{POLYGONTYPES:["esriSFSSolid"]},initialize:function(t,i){o.prototype.initialize.call(this,t,i),t&&(t.outline&&"esriSLSNull"===t.outline.style?this._lineStyles={weight:0}:this._lineStyles=l(t.outline,i).style(),this._fillStyles())},_fillStyles:function(){if(this._lineStyles)if(0===this._lineStyles.weight)this._styles.stroke=!1;else for(var t in this._lineStyles)this._styles[t]=this._lineStyles[t];this._symbolJson&&(this._symbolJson.color&&c.POLYGONTYPES.indexOf(0<=this._symbolJson.style)?(this._styles.fill=!0,this._styles.fillColor=this.colorValue(this._symbolJson.color),this._styles.fillOpacity=this.alphaValue(this._symbolJson.color)):(this._styles.fill=!1,this._styles.fillOpacity=0))},style:function(t,i){if(!this._isDefault&&i&&i.colorInfo){var e=this.getColor(t,i.colorInfo);e&&(this._styles.fillColor=this.colorValue(e),this._styles.fillOpacity=this.alphaValue(e))}return this._styles}});function f(t,i){return new c(t,i)}var p=a.Class.extend({options:{proportionalPolygon:!1,clickable:!0},initialize:function(t,i){this._rendererJson=t,this._pointSymbols=!1,this._symbols=[],this._visualVariables=this._parseVisualVariables(t.visualVariables),a.Util.setOptions(this,i)},_parseVisualVariables:function(t){var i={};if(t)for(var e=0;e<t.length;e++)i[t[e].type]=t[e];return i},_createDefaultSymbol:function(){this._rendererJson.defaultSymbol&&(this._defaultSymbol=this._newSymbol(this._rendererJson.defaultSymbol),this._defaultSymbol._isDefault=!0)},_newSymbol:function(t){return"esriSMS"===t.type||"esriPMS"===t.type?(this._pointSymbols=!0,n(t,this.options)):"esriSLS"===t.type?l(t,this.options):"esriSFS"===t.type?f(t,this.options):void 0},_getSymbol:function(){},attachStylesToLayer:function(t){this._pointSymbols?t.options.pointToLayer=a.Util.bind(this.pointToLayer,this):(t.options.style=a.Util.bind(this.style,this),t._originalStyle=t.options.style)},pointToLayer:function(t,i){var e=this._getSymbol(t);return e&&e.pointToLayer?e.pointToLayer(t,i,this._visualVariables,this.options):a.circleMarker(i,{radius:0,opacity:0})},style:function(t){var i;this.options.userDefinedStyle&&(i=this.options.userDefinedStyle(t));var e=this._getSymbol(t);return e?this.mergeStyles(e.style(t,this._visualVariables),i):this.mergeStyles({opacity:0,fillOpacity:0},i)},mergeStyles:function(t,i){var e,s={};for(e in t)t.hasOwnProperty(e)&&(s[e]=t[e]);if(i)for(e in i)i.hasOwnProperty(e)&&(s[e]=i[e]);return s}}),d=p.extend({initialize:function(t,i){p.prototype.initialize.call(this,t,i),this._createSymbol()},_createSymbol:function(){this._rendererJson.symbol&&this._symbols.push(this._newSymbol(this._rendererJson.symbol))},_getSymbol:function(){return this._symbols[0]}});function S(t,i){return new d(t,i)}var m=p.extend({initialize:function(t,i){p.prototype.initialize.call(this,t,i),this._field=this._rendererJson.field,this._rendererJson.normalizationType&&"esriNormalizeByField"===this._rendererJson.normalizationType&&(this._normalizationField=this._rendererJson.normalizationField),this._createSymbols()},_createSymbols:function(){var t,i=this._rendererJson.classBreakInfos;this._symbols=[];for(var e=i.length-1;0<=e;e--)(t=this.options.proportionalPolygon&&this._rendererJson.backgroundFillSymbol?this._newSymbol(this._rendererJson.backgroundFillSymbol):this._newSymbol(i[e].symbol)).val=i[e].classMaxValue,this._symbols.push(t);this._symbols.sort(function(t,i){return t.val>i.val?1:-1}),this._createDefaultSymbol(),this._maxValue=this._symbols[this._symbols.length-1].val},_getSymbol:function(t){var i=t.properties[this._field];if(this._normalizationField){var e=t.properties[this._normalizationField];if(isNaN(e)||0===e)return this._defaultSymbol;i/=e}if(i>this._maxValue)return this._defaultSymbol;for(var s=this._symbols[0],o=this._symbols.length-1;0<=o&&!(i>this._symbols[o].val);o--)s=this._symbols[o];return s}});function b(t,i){return new m(t,i)}var v=p.extend({initialize:function(t,i){p.prototype.initialize.call(this,t,i),this._field=this._rendererJson.field1,this._createSymbols()},_createSymbols:function(){for(var t,i=this._rendererJson.uniqueValueInfos,e=i.length-1;0<=e;e--)(t=this._newSymbol(i[e].symbol)).val=i[e].value,this._symbols.push(t);this._createDefaultSymbol()},_getSymbol:function(t){var i=t.properties[this._field];if(this._rendererJson.fieldDelimiter&&this._rendererJson.field2){var e=t.properties[this._rendererJson.field2];if(e){i+=this._rendererJson.fieldDelimiter+e;var s=t.properties[this._rendererJson.field3];s&&(i+=this._rendererJson.fieldDelimiter+s)}}for(var o=this._defaultSymbol,n=this._symbols.length-1;0<=n;n--)this._symbols[n].val==i&&(o=this._symbols[n]);return o}});function g(t,i){return new v(t,i)}i.FeatureLayer.addInitHook(function(){if(!this.options.ignoreRenderer){var s=a.Util.bind(this.onAdd,this),e=a.Util.bind(this.unbindPopup,this),o=a.Util.bind(this.onRemove,this);a.Util.bind(this.createNewLayer,this),this.onAdd=function(e){this.metadata(function(t,i){t?console.warn("failed to load metadata from the service."):i&&i.drawingInfo&&(this.options.drawingInfo&&(i.drawingInfo=this.options.drawingInfo),"overlayPane"===this.options.pane&&"esriGeometryPoint"===i.geometryType&&(this.options.pane="markerPane"),this._setRenderers(i),s(e),this._addPointLayer(e))},this)},this.onRemove=function(t){if(o(t),this._pointLayer){var i=this._pointLayer.getLayers();for(var e in i)t.removeLayer(i[e])}},this.unbindPopup=function(){if(e(),this._pointLayer){var t=this._pointLayer.getLayers();for(var i in t)t[i].unbindPopup()}},this._addPointLayer=function(t){this._pointLayer&&(this._pointLayer.addTo(t),this._pointLayer.bringToFront())},this._createPointLayer=function(){if(!this._pointLayer&&(this._pointLayer=a.geoJson(),this._pointLayerIds={},this._popup)){this._pointLayer.options.onEachFeature=a.Util.bind(function(t,i){i.bindPopup(this._popup(t,i),this._popupOptions)},this)}},this.createNewLayer=function(t){var i=a.GeoJSON.geometryToLayer(t,this.options);if(this._hasProportionalSymbols){var e=this.getPolygonCentroid(t.geometry.coordinates);if(!isNaN(e[0])&&!isNaN(e[0])){this._createPointLayer();var s=t.id.toString();if(!this._pointLayerIds[s]){var o=this.getPointJson(t,e);this._pointLayer.addData(o),this._pointLayerIds[s]=!0}this._pointLayer.bringToFront()}}return i},this.getPolygonCentroid=function(t){var i=t[0][0];2===i.length&&(i=t[0]);for(var e,s,o,n=0,r=0,l=0,a=i.length,h=0,u=a-1;h<a;u=h++)e=i[h],s=i[u],n+=e[0]*s[1],n-=e[1]*s[0],o=e[0]*s[1]-s[0]*e[1],r+=(e[0]+s[0])*o,l+=(e[1]+s[1])*o;return[r/(o=3*n),l/o]},this.getPointJson=function(t,i){return{type:"Feature",properties:t.properties,id:t.id,geometry:{type:"Point",coordinates:[i[0],i[1]]}}},this._checkForProportionalSymbols=function(t,i){if(this._hasProportionalSymbols=!1,"esriGeometryPolygon"===t&&(i.backgroundFillSymbol&&(this._hasProportionalSymbols=!0),i.classBreakInfos&&i.classBreakInfos.length)){var e=i.classBreakInfos[0].symbol;!e||"esriSMS"!==e.type&&"esriPMS"!==e.type||(this._hasProportionalSymbols=!0)}},this._setRenderers=function(t){var i,e=t.drawingInfo.renderer,s={url:this.options.url};switch(this.options.token&&(s.token=this.options.token),this.options.pane&&(s.pane=this.options.pane),t.drawingInfo.transparency&&(s.layerTransparency=t.drawingInfo.transparency),this.options.style&&(s.userDefinedStyle=this.options.style),e.type){case"classBreaks":if(this._checkForProportionalSymbols(t.geometryType,e),this._hasProportionalSymbols)this._createPointLayer(),b(e,s).attachStylesToLayer(this._pointLayer),s.proportionalPolygon=!0;i=b(e,s);break;case"uniqueValue":i=g(e,s);break;default:i=S(e,s)}i.attachStylesToLayer(this)}}}),t.VERSION="2.0.6",t.Renderer=p,t.SimpleRenderer=d,t.simpleRenderer=S,t.ClassBreaksRenderer=m,t.classBreaksRenderer=b,t.UniqueValueRenderer=v,t.uniqueValueRenderer=g,t.Symbol=o,t.PointSymbol=e,t.pointSymbol=n,t.LineSymbol=r,t.lineSymbol=l,t.PolygonSymbol=c,t.polygonSymbol=f});